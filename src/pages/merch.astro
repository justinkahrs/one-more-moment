---
import FadeIn from "../components/FadeIn.astro";
import Layout from "../layouts/Base.astro";

// Fetch products from Fourthwall Storefront API
const STOREFRONT_TOKEN = import.meta.env.FOURTHWALL_STOREFRONT_TOKEN;
const STOREFRONT_URL = "https://storefront-api.fourthwall.com/v1";

let products = [];
let error = null;

try {
  // 1. Get Collections to find a slug
  const collectionsRes = await fetch(
    `${STOREFRONT_URL}/collections?storefront_token=${STOREFRONT_TOKEN}`,
  );
  if (!collectionsRes.ok)
    throw new Error(`Failed to fetch collections: ${collectionsRes.status}`);

  const collectionsData = await collectionsRes.json();
  const collections = collectionsData.results || collectionsData; // Handle potential wrapper

  if (collections.length > 0) {
    const allCollection = collections.find((c: any) => c.slug === "all");
    const targetCollection = allCollection || collections[0];
    const slug = targetCollection.slug;

    const productsRes = await fetch(
      `${STOREFRONT_URL}/collections/${slug}/products?storefront_token=${STOREFRONT_TOKEN}&limit=500`,
    );
    if (!productsRes.ok)
      throw new Error(`Failed to fetch products: ${productsRes.status}`);

    const productsData = await productsRes.json();
    products = productsData.results || productsData;
  } else {
    // If no collections, maybe try empty search? But logic implies collections exist.
    console.warn("No collections found.");
  }
} catch (e) {
  error = e.message;
  console.error("Storefront API Error:", e);
}

// Fallback/Mock data if dev environment and API fails (optional, good for UI dev)
if (!products.length && import.meta.env.DEV && error) {
  products = [
    {
      id: "1",
      name: "Cool T-Shirt",
      images: [{ url: "https://placehold.co/400" }],
      variants: [
        {
          id: "var_1",
          unitPrice: { value: 25.0, currency: "USD" },
          name: "Default",
        },
      ],
    },
    {
      id: "2",
      name: "Awesome Hoodie",
      images: [{ url: "https://placehold.co/400" }],
      variants: [
        {
          id: "var_2",
          unitPrice: { value: 50.0, currency: "USD" },
          name: "Default",
        },
      ],
    },
  ];
}
---

<Layout title="Merch | One More Moment">
  <main class="container mx-auto px-4 py-12">
    <h1 class="mb-8 text-center text-4xl font-bold">Official Merch</h1>

    {
      error && !products.length ? (
        <div role="alert" class="alert alert-error mb-8">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6 shrink-0 stroke-current"
            fill="none"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
            />
          </svg>
          <span>
            Error loading products: {error}. Please check configuration.
          </span>
        </div>
      ) : null
    }

    <div class="grid grid-cols-1 gap-8 md:grid-cols-2 lg:grid-cols-3">
      {
        products.map((product) => {
          // Find price range or starting price
          const firstVar = product.variants?.[0];
          const minPrice = firstVar?.unitPrice;

          return (
            <FadeIn>
              <div class="card bg-base-100 shadow-xl transition-shadow duration-300 hover:shadow-2xl">
                <figure class="px-4 pt-4">
                  {product.images?.[0]?.url ? (
                    <img
                      src={product.images[0].url}
                      alt={product.name}
                      class="h-64 w-full rounded-xl object-cover"
                    />
                  ) : (
                    <div class="flex h-64 w-full items-center justify-center rounded-xl bg-gray-200 text-gray-500">
                      No Image
                    </div>
                  )}
                </figure>
                <div class="card-body items-center text-center">
                  <h2 class="card-title">{product.name}</h2>
                  <p class="text-lg font-semibold">
                    {minPrice
                      ? `From $${minPrice.value} ${minPrice.currency}`
                      : "Price unavailable"}
                  </p>
                  <div class="card-actions mt-4">
                    <button
                      class="btn btn-primary open-product-modal"
                      data-id={product.id}
                    >
                      Choose Options
                    </button>
                  </div>
                </div>
              </div>
            </FadeIn>
          );
        })
      }
    </div>
  </main>

  <slot name="overlay" />

  <!-- Product Modal -->
  <dialog id="product_modal" class="modal" slot="overlay">
    <div class="modal-box bg-base-100 w-11/12 max-w-4xl overflow-hidden p-0">
      <div class="flex h-full max-h-[85vh] flex-col md:flex-row">
        <!-- Image Section -->
        <div
          class="bg-base-200 flex w-full items-center justify-center p-6 md:w-1/2"
        >
          <img
            id="modal-image"
            src=""
            alt="Product"
            class="max-h-[50vh] rounded-lg object-contain shadow-sm"
          />
        </div>

        <!-- Details Section -->
        <div class="flex w-full flex-col overflow-y-auto p-8 md:w-1/2">
          <button
            class="btn btn-sm btn-circle btn-ghost absolute top-4 right-4 z-10"
            onclick="product_modal.close()">âœ•</button
          >

          <h3 class="mb-2 text-3xl font-bold" id="modal-title">Product Name</h3>
          <p class="text-primary mb-6 text-2xl font-semibold" id="modal-price">
            $0.00
          </p>

          <div id="modal-options" class="flex-1 space-y-6">
            <!-- Dynamic Options Injected Here -->
          </div>

          <div class="divider"></div>

          <div class="form-control mb-6 w-full max-w-xs">
            <label class="label"
              ><span class="label-text font-bold">Quantity</span></label
            >
            <div class="flex items-center">
              <button
                class="btn btn-square btn-outline btn-sm"
                onclick="window.updateModalQty(-1)">-</button
              >
              <input
                type="number"
                id="modal-qty"
                value="1"
                class="input input-bordered input-sm mx-2 w-20 text-center"
                min="1"
                readonly
              />
              <button
                class="btn btn-square btn-outline btn-sm"
                onclick="window.updateModalQty(1)">+</button
              >
            </div>
          </div>

          <button
            class="btn btn-primary btn-block btn-lg"
            id="modal-add-btn"
            disabled>Add to Cart</button
          >
        </div>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <script
    is:inline
    define:vars={{
      STOREFRONT_TOKEN,
      SHOP_URL:
        import.meta.env.FOURTHWALL_SHOP_URL || "checkout.fourthwall.com",
      PRODUCTS: products,
    }}
  >
    window.OMM_STOREFRONT_TOKEN = STOREFRONT_TOKEN;
    window.OMM_SHOP_URL = SHOP_URL;
    window.OMM_PRODUCTS = PRODUCTS;
  </script>

  <script src="/js/product-modal.js" is:inline></script>
  <!-- Shopping Cart UI (Drawer/Modal) -->
  <div slot="overlay" id="cart-drawer" class="fixed inset-0 z-[999] hidden">
    <div
      class="absolute inset-0 bg-black/50 backdrop-blur-sm"
      id="cart-overlay"
    >
    </div>
    <div
      class="bg-base-100 absolute top-0 right-0 flex h-full w-full max-w-md translate-x-full transform flex-col p-6 shadow-2xl transition-transform"
      id="cart-content"
    >
      <div class="mb-6 flex items-center justify-between">
        <h2 class="text-2xl font-bold">Your Cart</h2>
        <button class="btn btn-circle btn-ghost" id="close-cart">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            ><path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"></path></svg
          >
        </button>
      </div>

      <div id="cart-items" class="flex-1 space-y-4 overflow-y-auto">
        <!-- Cart items injected here -->
        <p class="mt-10 text-center text-gray-500">Your cart is empty.</p>
      </div>

      <div class="mt-4 border-t pt-4">
        <div class="mb-4 flex justify-between text-xl font-bold">
          <span>Total</span>
          <span id="cart-total">$0.00</span>
        </div>
        <button class="btn btn-primary btn-block" id="checkout-btn"
          >Checkout</button
        >
      </div>
    </div>
  </div>

  <!-- Floating Cart Button -->
  <button
    slot="overlay"
    id="open-cart-btn"
    class="btn btn-primary btn-circle btn-lg fixed right-8 bottom-8 z-40 shadow-lg"
  >
    <div class="indicator">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-6 w-6"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        ><path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"
        ></path></svg
      >
      <span class="indicator-item badge badge-secondary" id="cart-count">0</span
      >
    </div>
  </button>
</Layout>

<script src="/js/cart.js" is:inline></script>
