---
import Base from "../layouts/Base.astro";
import { events } from "../data/events";
import { Image } from "astro:assets";

const upcomingEvents = events.filter((e) => e.isUpcoming);
const pastEvents = events.filter((e) => !e.isUpcoming);
---

<Base title="Volunteer">
  <div class="container mx-auto max-w-4xl px-4 py-12">
    <div class="mb-16 text-center">
      <h1 class="mb-6 font-serif text-5xl text-[#2B2B40] md:text-6xl">
        Volunteer
      </h1>
      <p class="mx-auto max-w-2xl text-lg opacity-80">
        Join us in making a difference.
      </p>
    </div>

    {/* Upcoming Events */}
    <section class="mb-16">
      <h2 class="mb-6 font-serif text-2xl">Upcoming Volunteer Opportunities</h2>
      {
        upcomingEvents.length > 0 ? (
          <div class="grid grid-cols-1 gap-6 md:grid-cols-3">
            {upcomingEvents.map((event) => (
              <a
                href={`/events/${event.slug}`}
                class="card bg-base-100 border-base-200 border shadow-sm transition-all duration-300 hover:shadow-md"
              >
                {event.image && (
                  <figure class="h-48 overflow-hidden">
                    <Image
                      src={event.image}
                      alt={event.title}
                      class="h-full w-full object-cover transition-transform duration-500 hover:scale-105"
                    />
                  </figure>
                )}
                <div class="card-body">
                  <h3 class="card-title text-xl leading-tight font-medium">
                    {event.title}
                  </h3>
                  <div class="mt-2 font-mono text-sm opacity-70">
                    {event.date}
                  </div>
                  <div class="card-actions mt-4 justify-end">
                    <div class="badge rounded-md bg-[#D9776E] text-white hover:bg-[#c5665d]">
                      Details
                    </div>
                  </div>
                </div>
              </a>
            ))}
          </div>
        ) : (
          <p class="italic opacity-60">
            No upcoming opportunities at the moment. Please check back later.
          </p>
        )
      }
    </section>

    {/* Past Events */}
    <section class="mb-20">
      <h2 class="mb-6 font-serif text-2xl">Past Opportunities</h2>
      <div class="space-y-8">
        {
          pastEvents.map((event) => (
            <a
              href={`/events/${event.slug}`}
              class="group flex flex-col gap-6 sm:flex-row"
            >
              <div class="flex-1 space-y-2">
                <div class="font-mono text-sm opacity-60">{event.date}</div>
                <h3 class="font-serif text-2xl leading-tight font-medium decoration-1 underline-offset-4 group-hover:underline">
                  {event.title}
                </h3>
              </div>
              <div class="bg-base-200 aspect-[4/3] shrink-0 overflow-hidden rounded-2xl sm:w-48">
                {event.image && (
                  <Image
                    src={event.image}
                    alt={event.title}
                    class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-105"
                  />
                )}
              </div>
            </a>
          ))
        }
      </div>
    </section>

    {/* Get Involved Form */}
    <section>
      <h2 class="mb-8 font-serif text-4xl">Get Involved</h2>
      <form id="volunteer-request-form" class="flex flex-col gap-6">
        <div class="form-control w-full">
          <label class="label">
            <span class="label-text">Name</span>
          </label>
          <input
            type="text"
            name="name"
            placeholder="Type here"
            class="input input-bordered w-full rounded-md focus:outline-offset-0"
            required
          />
        </div>

        <div class="form-control w-full">
          <label class="label">
            <span class="label-text">Email</span>
          </label>
          <input
            type="email"
            name="email"
            placeholder="Type here"
            class="input input-bordered w-full rounded-md focus:outline-offset-0"
            required
          />
        </div>

        <div class="form-control w-full">
          <label class="label">
            <span class="label-text">How can you help?</span>
          </label>
          <textarea
            name="help"
            class="textarea textarea-bordered h-32 w-full rounded-md focus:outline-offset-0"
            placeholder="Tell us about your skills and interests"></textarea>
        </div>

        <div class="form-control w-full">
          <label class="label">
            <span class="label-text">Availability</span>
          </label>
          <input
            type="text"
            name="availability"
            placeholder="e.g. Weekends, Tuesday evenings"
            class="input input-bordered w-full rounded-md focus:outline-offset-0"
          />
        </div>

        <div class="mt-4">
          <button
            type="submit"
            class="btn min-w-[120px] rounded-md bg-[#D9776E] px-8 text-white hover:bg-[#c5665d]"
          >
            Submit
          </button>
        </div>
      </form>
    </section>
  </div>
</Base>

<script>
  const form = document.getElementById(
    "volunteer-request-form",
  ) as HTMLFormElement;

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const submitBtn = form.querySelector(
      'button[type="submit"]',
    ) as HTMLButtonElement;
    if (!submitBtn) return;

    const originalText = submitBtn.innerText;
    submitBtn.innerText = "Submitting...";
    submitBtn.disabled = true;

    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    try {
      const response = await fetch("/api/submit-volunteer", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
      });

      const result = await response.json();

      if (response.ok && result.success) {
        alert("Thank you for volunteering! We will be in touch soon.");
        form.reset();
      } else {
        alert(
          result.message || "Something went wrong. Please try again later.",
        );
      }
    } catch (error) {
      console.error("Error:", error);
      alert("An error occurred. Please try again.");
    } finally {
      submitBtn.innerText = originalText;
      submitBtn.disabled = false;
    }
  });
</script>
