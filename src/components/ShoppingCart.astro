---
// ShoppingCart component - floating cart widget
---

<div class="cart-widget fixed right-6 bottom-6 z-50">
    <div class="dropdown dropdown-end dropdown-top">
        <div
            tabindex="0"
            role="button"
            class="btn btn-circle btn-primary btn-lg shadow-2xl transition-transform duration-200 hover:scale-110"
            aria-label="Shopping Cart"
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"
                ></path>
            </svg>
            <span
                class="badge badge-secondary badge-sm cart-count absolute -top-2 -right-2"
                >0</span
            >
        </div>
        <div
            tabindex="-1"
            class="card dropdown-content bg-base-100 rounded-box z-1 mt-3 w-96 shadow-2xl"
        >
            <div class="card-body">
                <h3 class="card-title">Shopping Cart</h3>
                <div class="cart-items-container max-h-96 overflow-y-auto">
                    <div class="empty-cart-message py-8 text-center opacity-60">
                        Your cart is empty
                    </div>
                    <div class="cart-items space-y-2"></div>
                </div>
                <div class="cart-total mt-4 border-t pt-4">
                    <div class="flex justify-between text-xl font-bold">
                        <span>Total:</span>
                        <span class="cart-total-amount">$0.00</span>
                    </div>
                </div>
                <div class="card-actions mt-4">
                    <button class="btn btn-primary btn-block checkout-btn">
                        Checkout
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    interface CartItem {
        id: string;
        name: string;
        price: number;
        image: string;
        quantity: number;
    }

    function updateCartDisplay() {
        const cart: CartItem[] = JSON.parse(
            localStorage.getItem("cart") || "[]",
        );
        const cartCount = document.querySelector(".cart-count");
        const cartItemsContainer = document.querySelector(".cart-items");
        const emptyMessage = document.querySelector(".empty-cart-message");
        const totalAmount = document.querySelector(".cart-total-amount");

        // Update cart count
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        if (cartCount) cartCount.textContent = totalItems.toString();

        // Update cart items display
        if (cartItemsContainer && emptyMessage && totalAmount) {
            if (cart.length === 0) {
                emptyMessage.classList.remove("hidden");
                cartItemsContainer.innerHTML = "";
            } else {
                emptyMessage.classList.add("hidden");
                cartItemsContainer.innerHTML = cart
                    .map(
                        (item) => `
          <div class="flex items-center gap-3 rounded-lg bg-base-200 p-3" data-item-id="${item.id}">
            <img src="${item.image}" alt="${item.name}" class="h-16 w-16 rounded object-cover" />
            <div class="flex-1">
              <div class="font-semibold text-sm">${item.name}</div>
              <div class="text-primary text-sm">$${item.price.toFixed(2)}</div>
            </div>
            <div class="flex items-center gap-2">
              <button class="btn btn-xs btn-circle decrease-qty" data-id="${item.id}">-</button>
              <span class="font-semibold w-6 text-center">${item.quantity}</span>
              <button class="btn btn-xs btn-circle increase-qty" data-id="${item.id}">+</button>
              <button class="btn btn-xs btn-circle btn-error remove-item" data-id="${item.id}">âœ•</button>
            </div>
          </div>
        `,
                    )
                    .join("");

                // Calculate total
                const total = cart.reduce(
                    (sum, item) => sum + item.price * item.quantity,
                    0,
                );
                totalAmount.textContent = `$${total.toFixed(2)}`;

                // Add event listeners for cart item buttons
                attachCartItemListeners();
            }
        }
    }

    function attachCartItemListeners() {
        // Increase quantity
        document.querySelectorAll(".increase-qty").forEach((btn) => {
            btn.addEventListener("click", (e) => {
                const id = (e.currentTarget as HTMLElement).dataset.id!;
                const cart: CartItem[] = JSON.parse(
                    localStorage.getItem("cart") || "[]",
                );
                const item = cart.find((item) => item.id === id);
                if (item) {
                    item.quantity += 1;
                    localStorage.setItem("cart", JSON.stringify(cart));
                    updateCartDisplay();
                }
            });
        });

        // Decrease quantity
        document.querySelectorAll(".decrease-qty").forEach((btn) => {
            btn.addEventListener("click", (e) => {
                const id = (e.currentTarget as HTMLElement).dataset.id!;
                const cart: CartItem[] = JSON.parse(
                    localStorage.getItem("cart") || "[]",
                );
                const item = cart.find((item) => item.id === id);
                if (item && item.quantity > 1) {
                    item.quantity -= 1;
                    localStorage.setItem("cart", JSON.stringify(cart));
                    updateCartDisplay();
                }
            });
        });

        // Remove item
        document.querySelectorAll(".remove-item").forEach((btn) => {
            btn.addEventListener("click", (e) => {
                const id = (e.currentTarget as HTMLElement).dataset.id!;
                let cart: CartItem[] = JSON.parse(
                    localStorage.getItem("cart") || "[]",
                );
                cart = cart.filter((item) => item.id !== id);
                localStorage.setItem("cart", JSON.stringify(cart));
                updateCartDisplay();
            });
        });
    }

    // Checkout button
    function initCheckout() {
        const checkoutBtn = document.querySelector(".checkout-btn");
        if (checkoutBtn && !(checkoutBtn as HTMLElement).dataset.initialized) {
            (checkoutBtn as HTMLElement).dataset.initialized = "true";
            checkoutBtn.addEventListener("click", () => {
                const cart: CartItem[] = JSON.parse(
                    localStorage.getItem("cart") || "[]",
                );
                if (cart.length > 0) {
                    alert(
                        "Checkout feature coming soon! This is a demo implementation.",
                    );
                }
            });
        }
    }

    // Initialize on page load and when cart is updated
    function initCart() {
        updateCartDisplay();
        initCheckout();
    }

    document.addEventListener("astro:page-load", initCart);
    window.addEventListener("cartUpdated", updateCartDisplay);
    initCart();
</script>
